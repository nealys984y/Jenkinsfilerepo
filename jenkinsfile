pipeline {
  agent any

  environment {
    REPO_URL = 'https://github.com/nealys984y/docker-jenkins.git'
    REPO_BRANCH = 'main' // or any other branch you want to checkout
    DOCKER_IMAGE_NAME = 'ys984y/docker_training'
    GIT_TOKEN= 'GIT_PAT'
    BUILD_ARG1= 'value1'
    BUILD_ARG2= '${GIT_TOKEN}'
  }

stages {
  stage('Checkout Code') {
    steps {
      script {
        checkout scmGit(
          branches: [[name: 'main']],
          userRemoteConfigs: [[credentialsId: 'GIT_PAT',
            url: 'https://github.com/nealys984y/docker-jenkins.git']])
      }
    }
  }

  stage('Build Docker Image') {
    steps {
      script {
        withCredentials([usernamePassword(credentialsId: 'GIT_PAT', usernameVariable: 'GIT_USER', passwordVariable: 'GIT_PAT1')]){
        app = docker.build("${DOCKER_IMAGE_NAME}", "--build-arg ARG1=${GIT_PAT1} --build-arg ARG2=${BUILD_ARG2} .")
        }
      }
    }
   }

  stage('Test image') {
    steps {
      script {
       app.inside {
            sh """ echo 'Tests passed'
                    which docker
                    /usr/bin/docker --version
               """
        }

      }
    }
  }

  stage('Push image') {
    steps {
      script{  
        docker.withRegistry('https://registry.hub.docker.com', 'docker-hub') {
            app.push("${env.BUILD_NUMBER}")
            app.push("latest")
        }
      }
    }
   }
  }

}
